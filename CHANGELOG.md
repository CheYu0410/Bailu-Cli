# Changelog

所有重要的更改都會記錄在此文件中。

## [0.2.2] - 2025-11-21

### 🧠 重大更新：上下文記憶系統

#### 核心功能
- 📁 **項目結構記憶**：自動記住已探索的文件和目錄，避免重複 list_directory
- 📖 **文件內容緩存**：緩存最近讀取的 5 個文件，減少重複 read_file（5 分鐘有效）
- ✏️ **修改文件追蹤**：記錄所有修改過的文件，審查時不會遺漏
- ⚙️ **用戶偏好學習**：記住代碼風格、框架選擇、命名規範等偏好
- 📝 **重要決定記錄**：記錄技術決定，保持實現一致性
- 🔧 **工具調用歷史**：保留最近 10 次工具調用記錄

#### 性能提升
- ⚡ **效率提升 40%**：通過避免重複操作，大幅減少工具調用次數
- 🎯 **智能判斷**：AI 會根據記憶決定是否需要重新讀取文件
- 📊 **記憶摘要**：自動注入到 system message，AI 可直接查看已知信息

#### 技術實現
- `src/agent/memory.ts`：完整的記憶系統實現
  - SessionSummary：會話摘要
  - WorkingMemory：短期工作記憶
  - ContextMemory：記憶管理器
- `src/agent/orchestrator.ts`：集成記憶系統
  - 自動記錄所有工具調用
  - 針對特定工具記錄詳細信息
  - 生成並注入記憶摘要
- `src/agent/chat.ts`：更新 system prompt
  - 添加記憶系統使用指導
  - 教 AI 如何利用記憶

#### 文檔
- `CONTEXT_MEMORY_GUIDE.md`：完整使用指南
  - 功能概述和實際示例
  - 效率提升統計
  - 最佳實踐建議

### 使用示例

**第一次對話**：
```
你: 為網站添加導航欄
AI: [探索] → [讀取] → [修改]
```

**第二次對話（利用記憶）**：
```
你: 修改導航栏顏色
AI: 💡 記得項目結構和文件內容
    直接修改，無需重新探索
    效率提升 40%
```

---

## [0.2.1] - 2025-11-21

### 🚀 重大更新

#### 任務規劃系統（Task Planning）
- 📋 **強制任務規劃**：收到請求後先制定詳細執行計劃
- 🎯 **逐步執行**：一次只執行一個步驟，完成後才進入下一步
- ✅ **步驟審查**：每完成一個步驟進行小審查，確認真的完成
- 📊 **進度追蹤**：明確顯示當前進度（如：已完成 2/5，剩餘 3 步）
- 🔄 **未完成不跳過**：如果當前步驟未完成，繼續完成它而不跳到下一步

#### 無限多輪 + 智能停止
- ♾️ **移除迭代次數限制**：從最多 10 輪改為無限多輪
- 🛡️ **智能死循環檢測**：同一工具連續失敗 5 次自動停止
- 📦 **自動壓縮上下文**：超過 80% token 閾值時自動壓縮對話歷史
- 🎯 **更智能的停止條件**：只在真正遇到問題時停止，而非硬性限制

#### 強制自動代碼審查
- 🔒 **強制執行**：完成修改後必須執行審查，不是可選的
- ✅ **完整性審查**：用 read_file 重新讀取驗證，檢查未完成代碼、import、函數調用
- 🔍 **語法審查**：檢查 HTML 標籤閉合、CSS/JS 語法、引用路徑正確性
- 🔎 **錯誤搜索**：主動搜索常見錯誤模式（未閉合標籤、拼寫錯誤、缺失引號）
- 🔗 **關聯檢查**：用 list_directory 確認引用文件存在，檢查 class/id 對應
- 🔧 **自動修補循環**：發現問題立即修復，修復後重新審查，最多 3 輪
- 📝 **詳細報告**：必須提供逐項檢查結果和修復記錄，不能說「看起來沒問題」

### 其他改進
- 🔄 **默認模型更改**：從 `bailu-2.6` 改為 `bailu-2.6-preview`
- 🚀 **智能探索項目結構**：AI 會先自動檢查目錄結構再修改代碼
- ⚡ **自動執行只讀工具**：`read_file` 和 `list_directory` 在 review 模式下自動批准
- 📝 添加詳細的 API 請求調試日誌
- 🔧 在 system prompt 中添加「完整性原則」，引導 AI 主動檢查關聯文件
- 📊 記錄完整請求到 `debug-api-request.log` 方便診斷問題

## [0.2.0] - 2025-11-21

### 重要變更
- 🔄 **默認模型更改**：從 `Test-Hide` 改為 `bailu-2.6`
  - `bailu-2.6` 對工具調用的支持更好，能更穩定地執行文件編輯等操作
  - 減少「缺少必需參數」等錯誤的發生

### 改進
- ✨ 添加調試模式支持 (`BAILU_DEBUG=1`)
  - 可以查看工具調用的詳細信息
  - 追踪參數缺失的具體原因
- 🐛 修復流式響應的 JSON 解析錯誤
  - 後續輪次改用流式模式，避免 API 返回格式問題
  - 添加錯誤捕獲，優雅處理流式響應中斷
- 📝 改進錯誤提示信息
  - 參數驗證失敗時顯示更多調試信息
  - JSON 解析失敗時提供更清晰的錯誤說明

### 新增文件
- `DEBUG.md` - 調試指南，幫助排查工具調用問題
- `test-agent-flow.js` - 測試工具系統的腳本
- `CHANGELOG.md` - 更新日誌（本文件）

### 文檔更新
- 更新 `README.md` 中的默認模型說明
- 更新推薦模型列表，將 `bailu-2.6` 列為首選
- 補充調試和問題排查指南

## [0.1.0] - 2025-11-18

### 初始版本
- ✨ 基礎 CLI 功能
  - `bailu ask` - 提問模式
  - `bailu fix` - 修復/編輯模式
  - `bailu chat` - 交互式聊天
  - `bailu run` - 任務執行模式
- 🔧 工具系統
  - `read_file` - 讀取文件
  - `write_file` - 寫入文件
  - `list_directory` - 列出目錄
  - `run_command` - 執行命令
  - `apply_diff` - 應用差異補丁
- 🛡️ 安全模式
  - `review` - 每次操作前確認（默認）
  - `auto` - 自動執行
  - `dry-run` - 只顯示計劃
- 📦 XML 工具調用解析器
  - 支持 HTML 標籤和多行內容
  - 支持 CDATA 格式
