# 📋 任务规划系统示例

## 功能说明

AI 收到用户请求后，会先制定详细的执行计划，然后**逐步执行**每个步骤，不会一次性完成所有任务。

---

## 完整示例：添加导航栏

### 用户请求
```
你: 为网站添加导航栏
```

---

### AI 的完整响应流程

#### 第 0 步：任务规划（必须先执行）

```
AI: 📋 任务规划：为网站添加导航栏

让我先分析这个任务需要哪些步骤：

1️⃣ 步骤 1/5: 探索项目结构
   - 使用 list_directory 查看项目文件
   - 确认 HTML/CSS/JS 的位置

2️⃣ 步骤 2/5: 读取现有 HTML
   - 使用 read_file 读取 index.html
   - 了解当前页面结构

3️⃣ 步骤 3/5: 修改 HTML 添加导航栏
   - 在 <body> 开头添加 <nav> 元素
   - 添加导航链接

4️⃣ 步骤 4/5: 修改 CSS 添加样式
   - 读取 style.css
   - 添加导航栏样式

5️⃣ 步骤 5/5: 代码审查和修补
   - 执行 6 步强制审查清单
   - 发现问题立即修复

预计总共需要 5 个步骤

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 第 1 步：探索项目结构

```
▶ 开始执行步骤 1/5: 探索项目结构

[自動執行] list_directory "."

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
工具执行成功

发现的文件和目录：
- index.html
- css/
  - style.css
- js/
  - main.js
- images/
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 步骤 1/5 审查：
   - 目标：了解项目结构 ✓ 已完成
   - 发现主页文件：index.html ✓
   - 发现样式文件：css/style.css ✓
   - 无遗漏 ✓

✓ 步骤 1/5 已完成

进度: [■□□□□] 1/5 完成，剩余 4 步

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 第 2 步：读取现有 HTML

```
▶ 开始执行步骤 2/5: 读取现有 HTML

[自動執行] read_file "index.html"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
工具执行成功

当前 index.html 内容：
<!DOCTYPE html>
<html>
<head>
    <title>我的网站</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h1>欢迎来到我的网站</h1>
    <p>这是主页内容</p>
</body>
</html>
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 步骤 2/5 审查：
   - 目标：了解现有 HTML 结构 ✓ 已完成
   - 确认 CSS 引用路径：css/style.css ✓
   - 确认插入导航栏的位置：<body> 开头 ✓
   - 无遗漏 ✓

✓ 步骤 2/5 已完成

进度: [■■□□□] 2/5 完成，剩余 3 步

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 第 3 步：修改 HTML 添加导航栏

```
▶ 开始执行步骤 3/5: 修改 HTML 添加导航栏

现在我将在 <body> 标签开头添加导航栏...

[需要確認] write_file "index.html"

新内容：
<!DOCTYPE html>
<html>
<head>
    <title>我的网站</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="#home" class="nav-link">首页</a>
            <a href="#about" class="nav-link">关于</a>
            <a href="#services" class="nav-link">服务</a>
            <a href="#contact" class="nav-link">联系</a>
        </div>
    </nav>
    
    <h1>欢迎来到我的网站</h1>
    <p>这是主页内容</p>
</body>
</html>

是否执行此操作? [y/n]:
```

用户确认：
```
你: y
```

AI 继续：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
工具执行成功

✅ 步骤 3/5 审查：
   - 目标：添加导航栏 HTML ✓ 已完成
   - 添加了 <nav> 元素 ✓
   - 添加了 4 个导航链接 ✓
   - 使用了语义化的 class 名称 ✓
   - 无遗漏 ✓

✓ 步骤 3/5 已完成

进度: [■■■□□] 3/5 完成，剩余 2 步

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 第 4 步：修改 CSS 添加样式

```
▶ 开始执行步骤 4/5: 修改 CSS 添加样式

先读取现有样式...

[自動執行] read_file "css/style.css"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
工具执行成功

当前样式：
body {
    margin: 0;
    font-family: Arial, sans-serif;
}

h1 {
    color: #333;
}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

现在添加导航栏样式...

[需要確認] write_file "css/style.css"

新内容：
body {
    margin: 0;
    font-family: Arial, sans-serif;
}

/* 导航栏样式 */
.navbar {
    background-color: #333;
    padding: 1rem 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
    display: flex;
    gap: 2rem;
}

.nav-link {
    color: white;
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    transition: background-color 0.3s;
}

.nav-link:hover {
    background-color: #555;
}

h1 {
    color: #333;
}

是否执行此操作? [y/n]:
```

用户确认：
```
你: y
```

AI 继续：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
工具执行成功

✅ 步骤 4/5 审查：
   - 目标：添加导航栏样式 ✓ 已完成
   - 添加了 .navbar 样式 ✓
   - 添加了 .nav-container 样式 ✓
   - 添加了 .nav-link 样式和悬停效果 ✓
   - 保留了原有样式 ✓
   - 无遗漏 ✓

✓ 步骤 4/5 已完成

进度: [■■■■□] 4/5 完成，剩余 1 步

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 第 5 步：代码审查和修补

```
▶ 开始执行步骤 5/5: 代码审查和修补

⚠️ 开始强制代码审查...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【a) 代码完整性审查】

[自動執行] read_file "index.html"

✓ 检查 TODO/省略标记... 无
✓ 检查所有标签... 已正确闭合
✓ 检查 CSS 引用... css/style.css 正确

[自動執行] list_directory "css"

✓ style.css 存在

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【b) 语法和引用审查】

[自動執行] read_file "css/style.css"

✓ .navbar class 在 HTML 中存在
✓ .nav-container class 在 HTML 中存在
✓ .nav-link class 在 HTML 中存在
✓ CSS 语法正确，无缺失分号
✓ 所有选择器有效

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【c) 搜索潜在错误】

正在搜索常见错误模式...
✓ 无未闭合标签
✓ 无拼写错误
✓ 无缺失引号
✓ 无重复 ID

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【d) 功能逻辑审查】

✓ 导航栏 HTML 结构完整
✓ 导航链接有 href 属性
✓ 样式完整（背景色、内边距、悬停效果）
✓ 响应式容器已设置
✓ 无需 JavaScript（纯 HTML/CSS 导航）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【e) 修补结果】

所有检查都通过，无需修复。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【f) 审查报告】

✅ 审查完成报告：

✓ 代碼完整性: 通過
  - HTML 标签正确闭合
  - CSS 文件存在且被引用

✓ 語法正確性: 通過
  - HTML 语法正确
  - CSS 语法正确

✓ 引用關聯: 通過
  - .navbar class 正确使用
  - .nav-container class 正确使用
  - .nav-link class 正确使用
  - css/style.css 引用正确

✓ 功能邏輯: 通過
  - 导航栏完整可用
  - 链接结构正确
  - 样式完整

✓ 發現並修復的問題: 0 個

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 步骤 5/5 审查：
   - 目标：完成代码审查 ✓ 已完成
   - 执行了 6 步审查清单 ✓
   - 所有检查都通过 ✓
   - 无需修补 ✓

✓ 步骤 5/5 已完成

进度: [■■■■■] 5/5 完成

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎉 所有任务完成！

✅ 任务总结：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✓ 步骤 1/5: 探索项目结构 - 已完成
✓ 步骤 2/5: 读取现有 HTML - 已完成
✓ 步骤 3/5: 修改 HTML 添加导航栏 - 已完成
✓ 步骤 4/5: 修改 CSS 添加样式 - 已完成
✓ 步骤 5/5: 代码审查和修补 - 已完成
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 执行统计：
- 总步骤数: 5
- 已完成: 5
- 工具调用: 6 次（4 次自动，2 次需确认）
- 发现问题: 0 个
- 修复次数: 0 次

✅ 导航栏已成功添加并通过完整审查！
```

---

## 对比：有无任务规划

### ❌ 没有任务规划（之前）

```
你: 为网站添加导航栏

AI: [立即开始修改]
    [需要確認] write_file "index.html"
    [需要確認] write_file "css/style.css"
    
    ✅ 完成！

问题：
- 不知道总共有多少步
- 不知道当前进度
- 可能跳过某些步骤
- 没有逐步审查
- 用户不清楚 AI 在做什么
```

### ✅ 有任务规划（现在）

```
你: 为网站添加导航栏

AI: 📋 任务规划：5 个步骤
    
    步骤 1/5: ... ✓ 已完成
    步骤 2/5: ... ✓ 已完成
    步骤 3/5: ... ✓ 已完成
    步骤 4/5: ... ✓ 已完成
    步骤 5/5: ... ✓ 已完成
    
    🎉 所有任务完成！

优势：
- 明确知道总共 5 步
- 实时显示进度
- 逐步执行，不跳过
- 每步都有审查
- 用户清楚了解进度
```

---

## 关键特性

### 1. 强制规划
- 收到请求后**必须先规划**
- 不能直接开始执行

### 2. 逐步执行
- **一次只执行一个步骤**
- 完成后才进入下一步
- 不会一次性完成所有任务

### 3. 步骤审查
- 每完成一个步骤，进行小审查
- 确认真的完成了
- 如果未完成，继续完成当前步骤

### 4. 进度追踪
- 明确显示：已完成 X/总数
- 可视化进度条
- 剩余步骤数量

### 5. 不跳过原则
- 如果当前步骤未完成
- 继续完成它
- 不跳到下一步

---

## 实际效果

### 用户体验提升
- ✅ 知道总共需要多少步
- ✅ 实时了解当前进度
- ✅ 清楚 AI 在做什么
- ✅ 不会突然完成（透明）

### 代码质量提升
- ✅ 不会跳过审查
- ✅ 不会遗漏步骤
- ✅ 逐步验证正确性
- ✅ 问题及时发现

### 可控性提升
- ✅ 可以在任何步骤暂停
- ✅ 可以要求重新执行某步
- ✅ 可以调整计划
- ✅ 完全透明可追踪

---

## 配合其他功能

### + 强制代码审查
```
步骤 5/5: 代码审查
  → 执行 6 步审查清单
  → 发现问题立即修复
  → 修复后重新审查
```

### + 智能探索
```
步骤 1/5: 探索项目结构
  → 自动执行 list_directory
  → 确认文件位置
  → 为后续步骤做准备
```

### + 自动修补循环
```
步骤 5/5: 代码审查
  → 发现问题
  → 自动修补（最多 3 次）
  → 重新审查
  → 直到通过
```

---

## 总结

任务规划系统让 AI 从"黑盒"变成"透明盒"：

**之前**：不知道 AI 要做什么，突然就完成了
**现在**：清楚知道每一步，实时追踪进度

**之前**：可能跳过某些步骤，遗漏审查
**现在**：逐步执行，每步审查，不跳过

**之前**：出错了不知道是哪一步的问题
**现在**：每步都有标记，容易定位问题

这就是真正的"智能助手"！🎯
